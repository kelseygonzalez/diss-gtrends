---
title: "gtrends_cleaning"
author: "Kelsey Gonzalez"
date: "2/7/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, glue, here, vroom, gtrendsR,
               lubridate, zoo)

```

# Functions
```{r}
find_mondays <- function(year) {
  mondays <- seq(ymd(glue("{year}-01-01")),ymd(glue("{year}-12-31")),by="1 day")
  mondays <- mondays[wday(mondays,label = TRUE) == "Mon" & mondays < today() - 7]
  return(mondays)
}
find_initial_trends <- function(keyword, period_list){
  period_list <- as.character(period_list)
  
  trends <- tibble(location = character(),
                   hits = numeric(),
                   keyword = character(),
                   date = character())
  
  for (period in period_list){ 
    ppl7<- as.character(ymd(period) + 7)
    
    trends <- gtrends(
      keyword = keyword,
      geo = "US",
      time = paste(period, ppl7),
      gprop = "web",
      category = 0,
      hl = "en-US")$interest_by_dma %>%
      tibble() %>%
      mutate(date = period,
             hits = as.numeric(hits)) %>% 
      select(-c(geo, gprop)) %>%
      bind_rows(trends)
  }
  
  return(trends)
}
find_scale_point <- function(keyword, year){
  if (year(today()) == year) {
    span <- glue("{year}-01-01 {as.character(today() - 7)}")
    } else {
      span <- glue("{year}-01-01 {year}-12-31")
    }
  
  if (nchar(span) != 21) stop('incorrect span')
  
  print(glue("keyword = {keyword}"))
  print(glue("span = {span}"))
  
  rescale <- gtrends(
    keyword = keyword,
    geo = "US-CA-803",
    time = span,
    gprop = "web",
    category = 0,
    hl = "en-US", 
    onlyInterest = TRUE, 
    low_search_volume = FALSE)$interest_over_time %>% 
    tibble()  %>% 
    mutate(date = ymd(date(date))+1,
           hits = ifelse(hits < 1, NA, hits)) %>%
    fill(hits)%>% 
    select(-c(gprop, keyword, geo, time, category)) %>% 
    rename(hits_rescale = hits)
  
  if (rescale %>% drop_na() %>% nrow() == 0) stop('no rows of data')
  return(rescale)
}
rescale_trends <- function(trends, rescale){
  rescale_ratio <- rescale %>%
    mutate(location = 'Los Angeles CA',
           hits_rescale = replace_na(hits_rescale, 0),
           hits_rescale = ifelse(hits_rescale == 0, 0.0001, hits_rescale)) %>% 
    left_join(trends %>% 
                 mutate(date = ymd(date)), by = c('date', 'location'))  %>% 
    mutate(rescale_ratio = hits_rescale/hits)  %>% 
    select(date, rescale_ratio)
  
  trends <- trends %>% 
    mutate(date = ymd(date)) %>% 
    group_by(location) %>% 
    fill(hits) %>%
    ungroup() %>% 
    left_join(rescale_ratio, by = "date") %>% 
    mutate(hits_transformed_a = hits * rescale_ratio)
  return(trends)
}
find_year_trends <- function(keyword, year){
  trends <- find_initial_trends(keyword, find_mondays(year))
  rescaled<- find_scale_point(keyword, year)
  rescaled_trends <- rescale_trends(trends, rescaled)
  
  rescaled_trends <- rescaled_trends %>% 
    mutate(location = str_to_upper(location),
           location = str_replace_all(location,"-", " - "),
           location = str_replace_all(location,",", ""),
           location = str_replace_all(location,"\\s(\\w{2})\\b", " \\(\\1\\)")) %>% 
    select(DMA_google = location, !!keyword := hits_transformed_a, date)
  
  return(rescaled_trends)
}

find_cross_sectional_trends <- function(keyword, date_begin, span_type = 'month'){
  if (span_type == 'week'){
    ppl <- as.character(ymd(date_begin) + 7)
  }
  if (span_type == 'two-week'){
    ppl <- as.character(ymd(date_begin) + 14)
  }
  if (span_type == 'month'){
    ppl <- as.character(ymd(date_begin) + 31)
  }
  if (span_type == 'year'){
    ppl <- as.character(ymd(date_begin) + 365)
  }
  
  print(glue("keyword = {keyword}"))
  print(glue("span = {date_begin} - {ppl}"))
  
  trends <- gtrends(
    keyword = keyword,
    geo = "US",
    time = paste(date_begin, ppl),
    gprop = "web",
    category = 0,
    hl = "en-US")$interest_by_dma %>%
    tibble() %>%
    mutate(date = date_begin,
           hits = as.numeric(hits)) %>% 
    select(-c(geo, gprop)) 
  
  return(trends)
  
}
```




# attitudinal
• Vaccine Hesitancy
		○ https://data.cdc.gov/Vaccinations/Vaccine-Hesitancy-for-COVID-19-County-and-local-es/q9mh-h2tw/data
		
cross-sectional
dates - March 3, 2021 – March 15, 2021
```{r}
find_cross_sectional_trends('trend', '2021-03-03', 'two-week')
```



• Mask Usage
		○ New York Times Survey
		○ https://github.com/nytimes/covid-19-data/tree/master/mask-use

cross-sectional
July 2 and July 14, 2020
```{r}
find_cross_sectional_trends('trend', '2020-07-02', 'two-week')
```


# health
• Covid Rates
		○ https://github.com/nytimes/covid-19-data/tree/master/rolling-averages
longitudinal
dates - 

find_year_trends <- function(keyword, year)


• Suicide
		○ https://wonder.cdc.gov/mcd.html 
		○ Multiple Cause of Death Data 2019 (see notes for which variables count)
dates - 


# political
• Presidential results
		○ https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/VOQCHQ
		○ MIT Election Data and Science Lab, 2018, 
		○ "County Presidential Election Returns 2000-2020",
		○ https://doi.org/10.7910/DVN/VOQCHQ, 
		○ Harvard Dataverse, V9